#!/bin/bash
set -e

echo "Starting postBuild script"

# Install zsh if not already installed
if ! command -v zsh &> /dev/null; then
    echo "Installing zsh"
    apt-get update && apt-get install -y zsh
fi

# Set zsh as default shell for jovyan user
if [ -f /bin/zsh ]; then
    echo "Setting zsh as default shell"
    chsh -s /bin/zsh jovyan || echo "Failed to change shell to zsh"
fi

# Set paths - use the jovyan home directory
export PATH="/home/jovyan/.local/bin:${PATH}"

# Install Typst via the official installer
echo "Installing Typst"
mkdir -p /home/jovyan/.local/bin

curl -fsSL https://typst.community/typst-install/install.sh | sh || echo "Typst installation failed"

# Add to bashrc
echo 'export TYPST_INSTALL="/home/jovyan/.typst"' >> /home/jovyan/.bashrc
echo 'export PATH="$TYPST_INSTALL/bin:$PATH"' >> /home/jovyan/.bashrc

# Add to zshrc
echo 'export TYPST_INSTALL="/home/jovyan/.typst"' >> /home/jovyan/.zshrc
echo 'export PATH="$TYPST_INSTALL/bin:$PATH"' >> /home/jovyan/.zshrc
echo 'export PATH="/home/jovyan/.local/bin:${PATH}"' >> /home/jovyan/.zshrc
echo 'export PUPPETEER_EXECUTABLE_PATH="/usr/bin/chromium"' >> /home/jovyan/.zshrc

# Set environment variables
export TYPST_INSTALL="/home/jovyan/.typst"
export PATH="${TYPST_INSTALL}/bin:${PATH}"
export PUPPETEER_EXECUTABLE_PATH="/usr/bin/chromium"

# Install Python dependencies - try with uv first, fallback to pip
echo "Installing Python dependencies"

if which uv; then
  uv sync --all-extras --check --no-cache || uv run pip install --no-cache-dir -e .
else
  echo "Error with uv"
fi

cd /home/jovyan

# Install npm packages in the current directory
echo "Installing npm packages"
npm install --no-fund --force || echo "npm install failed"

# Build components
echo "Building components"
node build-components.mjs || echo "build-components.mjs failed"

# Build JupyterLab - try with uv first, fallback to jupyter directly
echo "Building JupyterLab"

if which uv; then
  uv run jupyter lab build --dev-build=False --minimize=False || echo "jupyter lab build failed"
else
  echo "uv can't launch jupyter lab. See logs"
fi

echo "postBuild script completed"
