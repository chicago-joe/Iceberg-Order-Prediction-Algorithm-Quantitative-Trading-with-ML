#!/bin/bash
#set -e

echo "Starting postBuild script"

# Install zsh if not already installed
if ! command -v zsh &> /dev/null; then
    echo "Installing zsh"
    apt-get update && apt-get install -y zsh
fi

# Set zsh as default shell for jovyan user
if [ -f /bin/zsh ]; then
    echo "Setting zsh as default shell"
    chsh -s /bin/zsh jovyan || echo "Failed to change shell to zsh"
fi

# Set paths - use the root directory
#export PATH="/root/.local/bin:${PATH}"

# Install Typst via the official installer
echo "Installing Typst"
mkdir -p /root/.local/bin

curl -fsSL https://typst.community/typst-install/install.sh | sh || echo "Typst installation failed"

# Add to bashrc
echo 'export TYPST_INSTALL="/root/.typst"' >> /root/.bashrc
echo 'export PATH="$TYPST_INSTALL/bin:$PATH"' >> /root/.bashrc

# Add to zshrc
echo 'export TYPST_INSTALL="/root/.typst"' >> /root/.zshrc
echo 'export PATH="$TYPST_INSTALL/bin:$PATH"' >> /root/.zshrc
echo 'export PATH="/root/.local/bin:${PATH}"' >> /root/.zshrc
echo 'export PUPPETEER_EXECUTABLE_PATH="/usr/bin/chromium"' >> /root/.zshrc

# Set environment variables
export TYPST_INSTALL="/root/.typst"
export PATH="${TYPST_INSTALL}/bin:${PATH}"
export PUPPETEER_EXECUTABLE_PATH="/usr/bin/chromium"

# Navigate to the repository directory instead of home
cd /app/Iceberg-Order-Prediction-Algorithm-Quantitative-Trading-with-ML

# Install Python dependencies - try with uv first, fallback to pip
echo "Installing Python dependencies"

if which uv; then
  uv sync --all-extras --check --no-cache || uv run pip install --no-cache-dir -e .
else
  echo "Error with uv"
fi

# Install npm packages in the repository directory
echo "Installing npm packages"
npm install --no-fund --force || echo "npm install failed"

# Build components
echo "Building components"
node build-components.mjs || echo "build-components.mjs failed"

# Build JupyterLab - try with uv first, fallback to jupyter directly
echo "Building JupyterLab"

if which uv; then
  uv run jupyter lab build --dev-build=False --minimize=False || echo "jupyter lab build failed"
else
  echo "uv can't launch jupyter lab. See logs"
fi

echo "postBuild script completed"
